name: Build OpenWrt 24.10

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: v24.10.5
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  CACHE_TOOLCHAIN: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Check Server Performance
      run: |
        echo "警告⚠"
        echo "分配的服务器性能有限，若选择的插件过多，务必注意CPU性能！"
        echo -e "已知CPU型号(降序): 7763，8370C，8272CL，8171M，E5-2673\n"
        echo "--------------------------CPU信息--------------------------"
        echo "CPU物理数量: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo "CPU核心数量: $(nproc)"
        echo -e "CPU型号信息:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
        echo "--------------------------内存信息--------------------------"
        echo "已安装内存详细信息:"
        echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
        echo "--------------------------硬盘信息--------------------------"
        echo "硬盘数量: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        docker rmi `docker images -q`
        sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
        sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google-chrome-stable microsoft-edge-stable dotnet* powershell openjdk* mysql* php* || true
        sudo -E apt-get -y update
        sudo -E apt-get -y install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get clean
        df -hT
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    # === 修正 1: 将 Go 安装移到“切盘”之前 ===
    # 这样 Go 安装占用的空间就算在系统盘里，不会导致切盘后溢出
    - name: Setup Go Environment
      uses: actions/setup-go@v5
      with:
        go-version: '1.25' 
        check-latest: true
        cache: true
    
    - name: Set Go Proxy
      run: |
        echo "GOPROXY=https://proxy.golang.org,direct" >> $GITHUB_ENV
        echo "GOPRIVATE=" >> $GITHUB_ENV

    # === 修正 2: 增加 root-reserve-mb 到 4GB (4096) ===
    - name: Combine Disks
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        temp-reserve-mb: 100
        root-reserve-mb: 4096 

    - name: Checkout
      uses: actions/checkout@main
        
    - name: Clone Source Code
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
    
    # === 插入位置：Clone Source Code 之后，Update Feeds 之前 ===
    - name: Cache Toolchain
      if: env.CACHE_TOOLCHAIN == 'true'
      uses: HiGarfield/cachewrtbuild@main
      with:
        ccache: false
        # mixkey 是缓存的唯一指纹
        # 只要 分支(v24.10.5) 和 架构(x86_64) 不变，就能命中缓存
        mixkey: ${{ env.REPO_BRANCH }}-x86_64
        prefix: ${{ github.workspace }}/openwrt

    - name: Update Feeds & Add Custom Sources
      run: |
        cd openwrt
        
        # 1. ⚠️ 必须先运行 update，确保基础 feeds 目录已存在且是最新的
        ./scripts/feeds update -a
        
        # 2. Update 之后，再强行替换 Golang 为 25.x 分支
        echo "Replacing Golang with 25.x branch..."
        rm -rf feeds/packages/lang/golang
        git clone https://github.com/sbwml/packages_lang_golang -b 25.x feeds/packages/lang/golang
        
        # 3. 最后安装所有包的链接
        ./scripts/feeds install -a

    - name: Install Custom Packages (DIY Script)
      run: |
        cd openwrt
        # --- 下载插件 ---
        git clone https://github.com/jerrykuku/luci-theme-argon.git package/luci-theme-argon
        git clone https://github.com/jerrykuku/luci-app-argon-config.git package/luci-app-argon-config
        git clone -b dev --depth=1 https://github.com/vernesong/OpenClash.git package/openclash
        
        rm -rf feeds/packages/net/v2ray-geodata
        git clone https://github.com/sbwml/luci-app-mosdns -b v5 package/mosdns
        git clone https://github.com/sbwml/v2ray-geodata package/v2ray-geodata
        
        git clone https://github.com/pexcn/openwrt-chinadns-ng.git package/chinadns-ng
        git clone https://github.com/immortalwrt/homeproxy.git package/homeproxy

        # --- 修改配置 ---
        # 修改 LAN IP
        sed -i 's/192.168.1.1/10.10.10.1/g' package/base-files/files/bin/config_generate
        # 修改默认主题
        sed -i 's/luci.main.mediaurlbase=.*/luci.main.mediaurlbase=\/luci-static\/argon/g' feeds/luci/modules/luci-base/root/etc/config/luci
        # 修复 Rust 编译
        if [ -f "feeds/packages/lang/rust/Makefile" ]; then
            sed -i 's|--set=llvm.download-ci-llvm=.*|--set=llvm.download-ci-llvm=false \\|' feeds/packages/lang/rust/Makefile
        fi

    - name: Generate Config File
      run: |
        cd openwrt
        rm -f .config
        
        # --- 1. 目标平台设置 (X86_64) ---
        # 如果你是 ARM 平台，请修改这里
        echo "CONFIG_TARGET_x86=y" >> .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config

        # --- 2. 核心设置 ---
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=10240" >> .config
        echo "CONFIG_PACKAGE_blockd=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config

        # --- 3. 插件设置 ---
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-argon-config=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-mosdns=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-statistics=y" >> .config
        echo "CONFIG_PACKAGE_chinadns-ng=y" >> .config
        echo "CONFIG_PACKAGE_homeproxy=y" >> .config

        # --- 4. 工具设置 ---
        echo "CONFIG_PACKAGE_tcpdump=y" >> .config
        echo "CONFIG_PACKAGE_vim-full=y" >> .config
        echo "CONFIG_PACKAGE_bash=y" >> .config
        echo "CONFIG_PACKAGE_zsh=y" >> .config
        echo "CONFIG_PACKAGE_fdisk=y" >> .config
        echo "CONFIG_PACKAGE_resize2fs=y" >> .config
        
        # --- 5. Collectd 模块 ---
        echo "CONFIG_PACKAGE_collectd=y" >> .config
        echo "CONFIG_PACKAGE_collectd-mod-cpu=y" >> .config
        echo "CONFIG_PACKAGE_collectd-mod-cpufreq=y" >> .config
        echo "CONFIG_PACKAGE_collectd-mod-interface=y" >> .config
        echo "CONFIG_PACKAGE_collectd-mod-load=y" >> .config
        echo "CONFIG_PACKAGE_collectd-mod-memory=y" >> .config
        echo "CONFIG_PACKAGE_collectd-mod-network=y" >> .config
        echo "CONFIG_PACKAGE_collectd-mod-sensors=y" >> .config

        # --- 6. ⚠️ 关键：BBR 和 FQ 内核配置 ---
        # 强制开启内核中的 FQ 和 BBR
        echo "CONFIG_NET_SCH_FQ=y" >> .config
        echo "CONFIG_kmod-tcp-bbr=y" >> .config
        echo "CONFIG_kmod-sched-fq=y" >> .config
        
        # === 修复 MosDNS 编译错误 ===
        # 关闭 UPX 压缩 (CI 环境容易失败，且对软路由性能无影响)
        echo "CONFIG_MOSDNS_COMPRESS_UPX=n" >> .config

        # 生成完整配置
        make defconfig

    - name: Download Sources
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile Firmware
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        
        # === 阶段 1: 编译基础工具链 (确保地基稳固) ===
        echo "Building Tools and Toolchain..."
        make tools/install -j$(nproc) || make tools/install -j1
        make toolchain/install -j$(nproc) || make toolchain/install -j1
        
        # === 阶段 3: 单独编译易出错的插件 (MosDNS) ===
        echo "Building MosDNS..."
        # 注意：MosDNS 我们之前说过要用单线程防止内存溢出
        make package/mosdns/compile -j1 V=s || exit 1
        
        # === 阶段 4: 编译剩余所有固件 ===
        echo "Building Firmware (Remaining)..."
        # 此时最难啃的骨头(OpenSSL)和最易碎的骨头(MosDNS)都啃完了，剩下的可以全速跑
        make -j$(nproc) || make -j1 || make -j1 V=s
        
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Organize Files
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload Firmware Directory
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success'
      with:
        name: OpenWrt_firmware
        path: ${{ env.FIRMWARE }}
    - name: Generate release tag
      id: tag
      if: steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        # 生成一个基于时间的标签，例如 v24.10.5-20251221
        echo "release_tag=v24.10.5-$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        touch release.txt
        echo "OpenWrt v24.10.5 自编译固件" >> release.txt
        echo "编译时间: $(date)" >> release.txt

    - name: Upload Firmware to Release
      uses: softprops/action-gh-release@v1
      if: steps.organize.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*
        
    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 1
        keep_minimum_runs: 3
