name: Build OpenWrt 24.10

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: v24.10.5
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  CACHE_TOOLCHAIN: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main

    # ✅ 【新增优化】使用专用 Action 深度清理磁盘
    # 这步会替代你原来的 "Initialization Environment" 中的部分清理代码
    # 能释放约 30GB+ 空间，总可用空间将达到 60GB+
    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@main
      with:
        # 删除所有不需要的预装软件
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true # ⚠ 关键：删除 Swap 分区可释放 7GB
    
    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # 只需要安装依赖即可，清理工作交给上面的 Action 完成了
        sudo -E apt-get -y update
        sudo -E apt-get -y install $(curl -fsSL https://is.gd/depend_ubuntu2204_openwrt)
        sudo -E systemctl daemon-reload
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get clean
        sudo timedatectl set-timezone "$TZ"
        
        # 显示清理后的空间情况
        echo "======================="
        echo "Space availability:"
        df -hT
        echo "======================="

    - name: Check Server Performance
      run: |
        echo "警告⚠"
        echo "分配的服务器性能有限，若选择的插件过多，务必注意CPU性能！"
        echo -e "已知CPU型号(降序): 7763，8370C，8272CL，8171M，E5-2673\n"
        echo "--------------------------CPU信息--------------------------"
        echo "CPU物理数量: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo "CPU核心数量: $(nproc)"
        echo -e "CPU型号信息:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
        echo "--------------------------内存信息--------------------------"
        echo "已安装内存详细信息:"
        echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
        echo "--------------------------硬盘信息--------------------------"
        echo "硬盘数量: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

    - name: Setup Go Environment
      uses: actions/setup-go@v5
      with:
        go-version: '1.25' 
        check-latest: true
        cache: true
    
    - name: Set Go Proxy
      run: |
        echo "GOPROXY=https://proxy.golang.org,direct" >> $GITHUB_ENV
        echo "GOPRIVATE=" >> $GITHUB_ENV

    - name: Clone Source Code
      run: |
        # ✅ 优化：加上 --depth 1 减少 git 历史占用
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt

    # === 缓存配置 ===
    - name: Cache Toolchain
      if: env.CACHE_TOOLCHAIN == 'true'
      uses: HiGarfield/cachewrtbuild@main
      with:
        ccache: false
        mixkey: ${{ env.REPO_BRANCH }}-x86_64
        prefix: ${{ github.workspace }}/openwrt

    - name: Update Feeds & Add Custom Sources
      run: |
        cd openwrt
        
        ./scripts/feeds update -a
        
        echo "Replacing Golang with 25.x branch..."
        rm -rf feeds/packages/lang/golang
        # ✅ 优化：加上 --depth 1
        git clone https://github.com/sbwml/packages_lang_golang -b 25.x --depth 1 feeds/packages/lang/golang
        
        ./scripts/feeds install -a

    - name: Install Custom Packages (DIY Script)
      run: |
        cd openwrt
        # ✅ 优化：所有 git clone 都加上 --depth 1
        git clone --depth 1 https://github.com/jerrykuku/luci-theme-argon.git package/luci-theme-argon
        git clone --depth 1 https://github.com/jerrykuku/luci-app-argon-config.git package/luci-app-argon-config
        git clone --depth 1 -b dev https://github.com/vernesong/OpenClash.git package/openclash
        
        rm -rf feeds/packages/net/v2ray-geodata
        git clone --depth 1 https://github.com/sbwml/luci-app-mosdns -b v5 package/mosdns
        git clone --depth 1 https://github.com/sbwml/v2ray-geodata package/v2ray-geodata
        
        git clone --depth 1 https://github.com/pexcn/openwrt-chinadns-ng.git package/chinadns-ng
        git clone --depth 1 https://github.com/immortalwrt/homeproxy.git package/homeproxy

        # --- 修改配置 ---
        sed -i 's/192.168.1.1/10.10.10.1/g' package/base-files/files/bin/config_generate
        sed -i 's/luci.main.mediaurlbase=.*/luci.main.mediaurlbase=\/luci-static\/argon/g' feeds/luci/modules/luci-base/root/etc/config/luci
        if [ -f "feeds/packages/lang/rust/Makefile" ]; then
            sed -i 's|--set=llvm.download-ci-llvm=.*|--set=llvm.download-ci-llvm=false \\|' feeds/packages/lang/rust/Makefile
        fi

    - name: Generate Config File
      run: |
        cd openwrt
        rm -f .config
        
        # --- 目标平台 ---
        echo "CONFIG_TARGET_x86=y" >> .config
        echo "CONFIG_TARGET_x86_64=y" >> .config
        echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config

        # --- 核心设置 ---
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=10240" >> .config
        echo "CONFIG_PACKAGE_blockd=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config

        # --- 插件 ---
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-argon-config=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-mosdns=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-statistics=y" >> .config
        echo "CONFIG_PACKAGE_chinadns-ng=y" >> .config
        echo "CONFIG_PACKAGE_homeproxy=y" >> .config

        # --- 工具 ---
        echo "CONFIG_PACKAGE_tcpdump=y" >> .config
        echo "CONFIG_PACKAGE_vim-full=y" >> .config
        echo "CONFIG_PACKAGE_bash=y" >> .config
        echo "CONFIG_PACKAGE_zsh=y" >> .config
        echo "CONFIG_PACKAGE_fdisk=y" >> .config
        echo "CONFIG_PACKAGE_resize2fs=y" >> .config
        
        # --- Collectd ---
        echo "CONFIG_PACKAGE_collectd=y" >> .config
        echo "CONFIG_PACKAGE_collectd-mod-cpu=y" >> .config
        echo "CONFIG_PACKAGE_collectd-mod-cpufreq=y" >> .config
        echo "CONFIG_PACKAGE_collectd-mod-interface=y" >> .config
        echo "CONFIG_PACKAGE_collectd-mod-load=y" >> .config
        echo "CONFIG_PACKAGE_collectd-mod-memory=y" >> .config
        echo "CONFIG_PACKAGE_collectd-mod-network=y" >> .config
        echo "CONFIG_PACKAGE_collectd-mod-sensors=y" >> .config

        # --- Kernel ---
        echo "CONFIG_NET_SCH_FQ=y" >> .config
        echo "CONFIG_kmod-tcp-bbr=y" >> .config
        echo "CONFIG_kmod-sched-fq=y" >> .config
        echo "CONFIG_MOSDNS_COMPRESS_UPX=n" >> .config

        make defconfig

    - name: Download Sources
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile Firmware
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Organize Files
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload Firmware Directory
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success'
      with:
        name: OpenWrt_firmware
        path: ${{ env.FIRMWARE }}
        
    - name: Generate release tag
      id: tag
      if: steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        echo "release_tag=v24.10.5-$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        touch release.txt
        echo "OpenWrt v24.10.5 自编译固件" >> release.txt
        echo "编译时间: $(date)" >> release.txt

    - name: Upload Firmware to Release
      uses: softprops/action-gh-release@v1
      if: steps.organize.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*
        
    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 1
        keep_minimum_runs: 3
